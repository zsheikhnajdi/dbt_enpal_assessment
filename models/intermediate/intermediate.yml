version: 2

models:
  - name: int_deal_stage_events
    description: "Deal stage entry events enriched with stage names (joined to stg_stages). One row per deal entering a stage at a specific time."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [deal_id, stage_id, entered_at]
    columns:
      - name: deal_id
        tests: [not_null]

      - name: entered_at
        tests: [not_null]

      - name: month
        tests: [not_null]

      - name: stage_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_stages')
                field: stage_id
      - name: stage_name
        tests: [not_null]

  - name: int_deal_stage_transitions
    description: "Deal stage transition events derived from deal_changes (stage_id updates). One row per deal entering a stage at a specific timestamp after deduplication."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [deal_id, stage_id, entered_at]
    columns:
      - name: deal_id
        tests: [not_null]
      - name: stage_id
        tests: [not_null]
      - name: entered_at
        tests: [not_null]



  - name: int_sales_call_events
    description: "Call events derived from activities; one record per deal and call_number (1/2), deduplicated and month-aligned for reporting."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [deal_id, call_number]
    columns:
      - name: month
        tests: [not_null]
      - name: deal_id
        tests: [not_null]
      - name: activity_date
        tests: [not_null]
      - name: call_number
        tests:
        - not_null
        - accepted_values:
            values: [1, 2]
